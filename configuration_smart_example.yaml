# Rozszerzona konfiguracja Home Assistant dla SMART systemu regresji jasnoci
# Zawiera wszystkie encje potrzebne dla inteligentnego sterowania z adaptacyjnym uczeniem

# Input text do przechowywania pr贸bek i wynik贸w regresji
input_text:
  # Przykad dla pokoju "garderoba_master" - zmie na swoj nazw
  brightness_lux_samples_garderoba_master:
    name: "Pr贸bki brightnesslux Garderoba Master"
    max: 3000  # Zwikszone dla wicej pr贸bek
    initial: ""

  brightness_regression_garderoba_master:
    name: "Regresja brightnesslux Garderoba Master"
    max: 300  # Wicej miejsca na dodatkowe dane
    initial: "a:1;b:0;r2:0;n:0;adaptive:false"

  last_sample_garderoba_master:
    name: "Ostatnia pr贸bka Garderoba Master"
    max: 50
    initial: ""

  # NOWE: Historia adaptacyjnego uczenia
  adaptive_history_garderoba_master:
    name: "Historia adaptacji Garderoba Master"
    max: 1000
    initial: ""

# Input numbers do przechowywania wsp贸czynnik贸w regresji
input_number:
  # Wsp贸czynniki regresji
  light_regression_a_garderoba_master:
    name: "Wsp贸czynnik A - Garderoba Master"
    min: -100
    max: 100
    step: 0.0001  # Wiksza precyzja
    initial: 1

  light_regression_b_garderoba_master:
    name: "Wsp贸czynnik B - Garderoba Master"
    min: -1000
    max: 1000
    step: 0.01  # Wiksza precyzja
    initial: 0

  regression_quality_garderoba_master:
    name: "Jako regresji R虏 - Garderoba Master"
    min: 0
    max: 1
    step: 0.001
    initial: 0

  # NOWE: Parametry adaptacyjnego uczenia
  adaptive_learning_rate_garderoba_master:
    name: "Szybko uczenia - Garderoba Master"
    min: 0.01
    max: 1.0
    step: 0.01
    initial: 0.1

  adaptive_error_threshold_garderoba_master:
    name: "Pr贸g bdu dla adaptacji - Garderoba Master"
    min: 5
    max: 100
    step: 1
    initial: 20

  # Monitorowanie wydajnoci
  average_prediction_error_garderoba_master:
    name: "redni bd przewidywa - Garderoba Master"
    min: 0
    max: 500
    step: 0.1
    initial: 0

  max_prediction_error_garderoba_master:
    name: "Maksymalny bd przewidywa - Garderoba Master"
    min: 0
    max: 1000
    step: 0.1
    initial: 0

# Input datetime
input_datetime:
  last_sample_time_garderoba_master:
    name: "Czas ostatniej pr贸bki - Garderoba Master"
    has_date: true
    has_time: true

  last_adaptive_update_garderoba_master:
    name: "Ostatnia adaptacyjna aktualizacja - Garderoba Master"
    has_date: true
    has_time: true

# Input boolean dla funkcji smart
input_boolean:
  smart_mode_enabled_garderoba_master:
    name: "Smart Mode wczony - Garderoba Master"
    initial: true

  adaptive_learning_enabled_garderoba_master:
    name: "Adaptacyjne uczenie wczone - Garderoba Master"
    initial: true

  daylight_compensation_garderoba_master:
    name: "Kompensacja wiata dziennego - Garderoba Master"
    initial: true

# Input select dla trybu domu (jeli nie masz)
input_select:
  home_mode:
    name: "Tryb domu"
    options:
      - normal
      - noc
      - impreza
      - relaks
      - film
      - sprzatanie
      - dziecko_spi
    initial: normal

  # NOWE: Agresywno adaptacji
  adaptive_mode_garderoba_master:
    name: "Tryb adaptacji - Garderoba Master"
    options:
      - conservative  # Powolne zmiany
      - normal       # Standardowe tempo
      - aggressive   # Szybkie dostosowanie
    initial: normal

# Python scripts
python_script:
  # Te pliki musz by w <config>/python_scripts/
  # calculate_brightness_regression.py (ulepszona wersja)
  # learn_brightness_lux.py (ulepszona wersja)
  # adaptive_learning.py (NOWY!)

# Sensory do monitorowania i diagnostyki
sensor:
  - platform: template
    sensors:
      # Jako regresji z kolorowym wska藕nikiem
      regression_quality_garderoba_master:
        friendly_name: "Jako regresji - Garderoba Master"
        value_template: >
          {% set regression_data = states('input_text.brightness_regression_garderoba_master') %}
          {% if 'r2:' in regression_data %}
            {% set r2_part = regression_data.split('r2:')[1].split(';')[0] %}
            {{ r2_part | float | round(3) }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "R虏"
        icon_template: >
          {% set r2 = states('sensor.regression_quality_garderoba_master') | float %}
          {% if r2 > 0.8 %}
            mdi:chart-line
          {% elif r2 > 0.5 %}
            mdi:chart-line-variant
          {% else %}
            mdi:alert-circle
          {% endif %}
        attribute_templates:
          status: >
            {% set r2 = states('sensor.regression_quality_garderoba_master') | float %}
            {% if r2 > 0.8 %}
              Doskonaa
            {% elif r2 > 0.6 %}
              Dobra
            {% elif r2 > 0.4 %}
              rednia
            {% else %}
              Saba
            {% endif %}

      # Przewidywane lux na podstawie obecnej jasnoci
      predicted_lux_garderoba_master:
        friendly_name: "Przewidywane lux - Garderoba Master"
        value_template: >
          {% set brightness = state_attr('light.garderoba_master', 'brightness') | int(0) %}
          {% set a = states('input_number.light_regression_a_garderoba_master') | float(1) %}
          {% set b = states('input_number.light_regression_b_garderoba_master') | float(0) %}
          {{ (a * brightness + b) | round(1) }}
        unit_of_measurement: "lx"
        icon_template: mdi:brightness-6

      # NOWE: Status smart mode
      smart_mode_status_garderoba_master:
        friendly_name: "Status Smart Mode - Garderoba Master"
        value_template: >
          {% set quality = states('input_number.regression_quality_garderoba_master') | float(0) %}
          {% set enabled = states('input_boolean.smart_mode_enabled_garderoba_master') %}
          {% if enabled == 'on' and quality >= 0.5 %}
            Smart Active
          {% elif enabled == 'on' and quality < 0.5 %}
            Fallback Mode
          {% else %}
            Disabled
          {% endif %}
        icon_template: >
          {% set status = states('sensor.smart_mode_status_garderoba_master') %}
          {% if status == 'Smart Active' %}
            mdi:brain
          {% elif status == 'Fallback Mode' %}
            mdi:cog-outline
          {% else %}
            mdi:power-off
          {% endif %}

      # Liczba pr贸bek w systemie
      sample_count_garderoba_master:
        friendly_name: "Liczba pr贸bek - Garderoba Master"
        value_template: >
          {% set samples = states('input_text.brightness_lux_samples_garderoba_master') %}
          {% if samples %}
            {{ samples.split(';') | length }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "pr贸bek"
        icon_template: mdi:database

      # NOWE: Bd przewidywa
      prediction_accuracy_garderoba_master:
        friendly_name: "Dokadno przewidywa - Garderoba Master"
        value_template: >
          {% set avg_error = states('input_number.average_prediction_error_garderoba_master') | float(0) %}
          {% if avg_error > 0 %}
            {{ (100 - avg_error) | round(1) }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "%"
        icon_template: mdi:target

# Automatyzacje dla smart systemu
automation:
  # Regularne przeliczanie regresji
  - alias: "Przelicz regresj co godzin (Smart)"
    trigger:
      - platform: time_pattern
        minutes: 0
    condition:
      - condition: template
        value_template: >
          {% set samples = states('input_text.brightness_lux_samples_garderoba_master') %}
          {{ samples != '' and samples.split(';') | length >= 10 }}
    action:
      - service: python_script.calculate_brightness_regression
        data:
          room_id: "garderoba_master"

  # NOWE: Adaptacyjne uczenie co 2 godziny
  - alias: "Adaptacyjne uczenie - Garderoba Master"
    trigger:
      - platform: time_pattern
        hours: "/2"
    condition:
      - condition: state
        entity_id: input_boolean.adaptive_learning_enabled_garderoba_master
        state: "on"
      - condition: template
        value_template: >
          {% set samples = states('input_text.brightness_lux_samples_garderoba_master') %}
          {{ samples != '' and samples.split(';') | length >= 20 }}
    action:
      - service: python_script.adaptive_learning
        data:
          room_id: "garderoba_master"
          learning_rate: "{{ states('input_number.adaptive_learning_rate_garderoba_master') | float(0.1) }}"
          min_samples_for_update: 15

  # Powiadomienie o niskiej jakoci regresji
  - alias: "Ostrze偶enie o sabej regresji (Smart)"
    trigger:
      - platform: numeric_state
        entity_id: sensor.regression_quality_garderoba_master
        below: 0.4
        for:
          minutes: 5
    action:
      - service: notify.persistent_notification
        data:
          title: "锔 Saba jako regresji"
          message: >
            Regresja dla garderoby master ma nisk jako (R虏={{ states('sensor.regression_quality_garderoba_master') }}). 
            Sprawd藕 pozycjonowanie czujnika lux lub dodaj wicej pr贸bek.
          notification_id: "regression_quality_warning"

  # NOWE: Powiadomienie o udanej adaptacji
  - alias: "Powiadomienie o adaptacji modelu"
    trigger:
      - platform: state
        entity_id: input_datetime.last_adaptive_update_garderoba_master
    condition:
      - condition: template
        value_template: >
          {{ trigger.to_state.state != trigger.from_state.state }}
    action:
      - service: notify.persistent_notification
        data:
          title: " Model zaktualizowany"
          message: >
            System adaptacyjnego uczenia poprawi model regresji dla garderoby master.
            Nowa jako: {{ states('sensor.regression_quality_garderoba_master') }}
          notification_id: "adaptive_update"

  # Automatyczne przeczanie na fallback mode
  - alias: "Auto fallback gdy saba jako"
    trigger:
      - platform: numeric_state
        entity_id: sensor.regression_quality_garderoba_master
        below: 0.3
    action:
      - service: logbook.log
        data:
          name: "Smart Lux System"
          message: "Automatyczne przeczenie na fallback mode z powodu sabej jakoci regresji"

# Dashboard - przykadowe karty
# (Dodaj to do swojego dashboard.yaml lub w UI)
lovelace:
  dashboards:
    smart-lighting:
      mode: yaml
      filename: smart_lighting_dashboard.yaml
      title: "Smart Owietlenie"
      icon: mdi:lightbulb-on
      show_in_sidebar: true

# Dodatkowe pomocnicze sensory
sensor:
  # Czas od ostatniej adaptacji
  - platform: template
    sensors:
      time_since_last_adaptation_garderoba_master:
        friendly_name: "Czas od ostatniej adaptacji"
        value_template: >
          {% if states('input_datetime.last_adaptive_update_garderoba_master') != 'unknown' %}
            {% set last_update = as_timestamp(states('input_datetime.last_adaptive_update_garderoba_master')) %}
            {% set now = as_timestamp(now()) %}
            {% set diff_hours = ((now - last_update) / 3600) | round(1) %}
            {% if diff_hours < 1 %}
              {{ ((now - last_update) / 60) | round(0) }} min temu
            {% elif diff_hours < 24 %}
              {{ diff_hours }} h temu
            {% else %}
              {{ (diff_hours / 24) | round(1) }} dni temu
            {% endif %}
          {% else %}
            Nigdy
          {% endif %}
        icon_template: mdi:clock-outline 